<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadow Omni V8.5 - Private Edge AI</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { 
            --bg: #0c0c0d; 
            --accent: #00f2ff; 
            --text: #e3e3e3; 
            --mood-color: #00f2ff; 
            --glass: rgba(30, 31, 32, 0.9); 
        }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        #top-bar { position: fixed; top: 20px; left: 20px; display: flex; gap: 10px; z-index: 100; }
        .toggle-btn { background: var(--glass); border: 1px solid #444; color: white; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 12px; transition: 0.3s; }
        .toggle-btn.active { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 10px rgba(0,242,255,0.3); }

        #settings-trigger { position: fixed; top: 20px; right: 20px; font-size: 24px; cursor: pointer; z-index: 100; opacity: 0.6; transition: 0.3s; }
        #settings-trigger:hover { opacity: 1; transform: rotate(45deg); }

        #settings-panel { position: fixed; top: 70px; right: 20px; background: var(--glass); border: 1px solid #333; padding: 20px; border-radius: 15px; width: 250px; display: none; backdrop-filter: blur(10px); z-index: 99; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .btn-small { background: #333; border: 1px solid #444; color: #ccc; font-size: 11px; padding: 10px; cursor: pointer; border-radius: 5px; width: 100%; margin-top: 10px; }
        
        #main { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; background: radial-gradient(circle at center, #111 0%, #000 100%); }
        .mood-glow { position: absolute; width: 450px; height: 450px; background: var(--mood-color); filter: blur(120px); opacity: 0.1; border-radius: 50%; pointer-events: none; transition: 0.8s; }
        
        #response-box { background: rgba(0, 242, 255, 0.05); border: 1px solid rgba(0, 242, 255, 0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px; text-align: center; color: var(--accent); font-size: 18px; max-width: 80%; min-height: 40px; transition: 0.3s; z-index: 1; overflow-y: auto; max-height: 150px; }

        .shadow-circle { width: 240px; height: 240px; border-radius: 50%; border: 2px solid var(--mood-color); display: flex; align-items: center; justify-content: center; transition: 0.5s; box-shadow: 0 0 20px rgba(0,242,255,0.2); }
        .avatar-img { width: 210px; height: 210px; border-radius: 50%; object-fit: cover; transition: 0.5s; }
        
        #input-container { padding: 40px 10%; width: 100%; box-sizing: border-box; }
        .input-wrapper { max-width: 600px; margin: 0 auto; background: var(--glass); border-radius: 40px; display: flex; align-items: center; padding: 5px 20px; border: 1px solid #333; }
        input { flex: 1; background: transparent; border: none; color: white; padding: 15px; outline: none; font-size: 16px; }

        .talking { animation: vibrate 0.2s infinite; border-width: 4px; }
        @keyframes vibrate { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        .anger-mode { animation: shake 0.15s infinite; border-color: #ff4b2b !important; box-shadow: 0 0 40px #ff4b2b !important; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -2px); } 100% { transform: translate(1px, -1px); } }
        .happy-mode { animation: breathe 2.5s ease-in-out infinite; border-color: #f9d423 !important; }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.08); } }
        
        #thought-process { font-size: 12px; color: #666; margin-bottom: 10px; font-style: italic; min-height: 15px; text-align: center; }
        #loading-bar-container { display:none; width: 200px; background: #222; height: 5px; border-radius: 5px; margin: 5px auto; }
        #loading-bar { width: 0%; background: var(--accent); height: 100%; transition: 0.3s; border-radius: 5px; }
    </style>
</head>
<body>

<div id="top-bar">
    <button id="btn-en" class="toggle-btn active" onclick="setLang('en-US')">Global (EN)</button>
    <button id="btn-hi" class="toggle-btn" onclick="setLang('hi-IN')">Local (HI)</button>
</div>

<div id="settings-trigger" onclick="toggleSettings()">‚öôÔ∏è</div>

<div id="settings-panel">
    <h4 style="margin:0 0 10px 0; color:var(--accent);">Security Shield</h4>
    <input type="password" id="masterKey" placeholder="Master Key..." style="width:100%; background:#000; color:white; border:1px solid #444; padding:8px; border-radius:4px; box-sizing:border-box;">
    <div id="auth-status" style="font-size:10px; color:#ffb700; margin-top:5px;">üîí Database Locked</div>
    <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
    <button class="btn-small" id="exportBtn">üì• Export Brain</button>
    <button class="btn-small" id="importTrigger">üì§ Import Brain</button>
    <input type="file" id="imp" style="display:none">
    <button class="btn-small" id="wipeBtn" style="color:#ff6b6b; border-color:#522;">‚ö†Ô∏è Wipe Data</button>
    <div style="font-size:10px; color:#666; margin-top:10px; text-align:center;">Memory: <span id="mem-count">0</span> Shards</div>
</div>

<div id="main">
    <div class="mood-glow" id="glow"></div>
    <div id="thought-process"></div>
    <div id="loading-bar-container">
        <div id="loading-bar"></div>
    </div>
    <div id="response-box">"Awaiting Master's command..."</div>
    <div class="shadow-circle" id="circle">
        <img src="https://cdn-icons-png.flaticon.com/512/4140/4140047.png" class="avatar-img" id="avatar">
    </div>
</div>

<div id="input-container">
    <div class="input-wrapper">
        <button id="voiceBtn" style="background:none; border:none; cursor:pointer;">üéôÔ∏è</button>
        <input type="text" id="userInput" placeholder="Ask or teach anything...">
        <button id="sendBtn" style="background:none; border:none; cursor:pointer; color:var(--accent);">‚û§</button>
    </div>
</div>

<script type="module">
import * as webllm from "https://esm.run/@mlc-ai/web-llm";

let currentLang = 'en-US';
const config = {
    'en-US': { placeholder: "Ask or teach anything...", welcome: "Systems Online. Privacy Shield Active.", learnMsg: "Knowledge absorbed, Master.", errorMsg: "I don't remember this. Thinking..." },
    'hi-IN': { placeholder: "Sikho (key | res) ya Poocho...", welcome: "‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§π‡•à‡•§ ‡§™‡•ç‡§∞‡§æ‡§á‡§µ‡•á‡§∏‡•Ä ‡§∂‡•Ä‡§≤‡•ç‡§° ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ ‡§π‡•à‡•§", learnMsg: "Sikh liya, Master.", errorMsg: "Ye yaad nahi hai. Soch raha hoon..." }
};

const ShadowOmni = {
    memory: {}, context: [], engine: null,
    moodMap: { anger: "#ff4b2b", happy: "#f9d423", cool: "#00f2ff", neutral: "#00f2ff" },

    loadMemory: function() {
        const pass = document.getElementById('masterKey').value;
        const data = localStorage.getItem('shadow_brain_enc');
        if (!data || !pass) return;
        try {
            const bytes = CryptoJS.AES.decrypt(data, pass);
            const dec = bytes.toString(CryptoJS.enc.Utf8);
            this.memory = JSON.parse(dec);
            document.getElementById('auth-status').innerText = "üîì Database Unlocked";
            document.getElementById('mem-count').innerText = Object.keys(this.memory).length;
        } catch (e) { document.getElementById('auth-status').innerText = "‚ùå Master Key Invalid"; }
    },

    sync: function() {
        const pass = document.getElementById('masterKey').value;
        if (!pass) return;
        const enc = CryptoJS.AES.encrypt(JSON.stringify(this.memory), pass).toString();
        localStorage.setItem('shadow_brain_enc', enc);
        document.getElementById('mem-count').innerText = Object.keys(this.memory).length;
        saveToIndexedDB(this.memory);
    },

    findFuzzy: function(q) {
        let query = q.toLowerCase().trim();
        if ((query.includes("‡§ó‡§≤‡§§") || query.includes("wrong")) && this.context.length > 0) return "correct_mode";
        if (this.memory[query]) return this.memory[query];
        for (let key in this.memory) {
            if (query.includes(key) || key.includes(query)) return this.memory[key];
        }
        return null;
    },

    initAI: async function() {
        const thoughtBox = document.getElementById('thought-process');
        const barContainer = document.getElementById('loading-bar-container');
        const bar = document.getElementById('loading-bar');
        
        barContainer.style.display = 'block';
        thoughtBox.innerText = "Initializing Local Neural Engine...";

        const modelId = "gemma-2b-it-q4f16_1-MLC"; 

        try {
            this.engine = await webllm.createEngine(modelId, {
                initProgressCallback: (report) => {
                    const progress = Math.round(report.progress * 100);
                    bar.style.width = progress + "%";
                    thoughtBox.innerText = `Loading Neural Brain: ${progress}%`;
                }
            });
            barContainer.style.display = 'none';
            thoughtBox.innerText = "Neural Engine Online (100% Private)";
        } catch (e) {
            thoughtBox.innerText = "WebGPU not supported. Using standard memory.";
            barContainer.style.display = 'none';
        }
    },

    askLLM: async function(prompt) {
        if (!this.engine) await this.initAI();
        if (!this.engine) return null;
        const messages = [{ role: "user", content: prompt }];
        const reply = await this.engine.chat.completions.create({ messages });
        return reply.choices[0].message.content;
    },

    bol: function(t, mood = 'neutral') {
        const box = document.getElementById('response-box');
        box.innerText = t;
        const circle = document.getElementById('circle');
        circle.classList.remove('anger-mode', 'happy-mode');
        if(mood === 'anger') circle.classList.add('anger-mode');
        if(mood === 'happy') circle.classList.add('happy-mode');

        window.speechSynthesis.cancel();
        const sentences = t.split(/[.‡•§!?,]|\n/g).filter(s => s.trim().length > 0);
        let index = 0;

        const speakSentence = () => {
            if (index < sentences.length) {
                const m = new SpeechSynthesisUtterance(sentences[index].trim());
                m.lang = currentLang;
                m.rate = 0.9; 
                m.onstart = () => circle.classList.add('talking');
                m.onend = () => { index++; setTimeout(speakSentence, 400); };
                window.speechSynthesis.speak(m);
            } else { circle.classList.remove('talking'); }
        };
        speakSentence();
    }
};

// Global Exposure for UI
window.setLang = (lang) => {
    currentLang = lang;
    document.getElementById('userInput').placeholder = config[lang].placeholder;
    document.getElementById('response-box').innerText = config[lang].welcome;
    document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn-${lang.split('-')[0]}`).classList.add('active');
};

window.toggleSettings = () => {
    const panel = document.getElementById('settings-panel');
    panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
};

async function handleUI() {
    const i = document.getElementById('userInput');
    const val = i.value.trim();
    const thoughtBox = document.getElementById('thought-process');
    if (!val) return;

    if (val.includes("|")) {
        let p = val.split("|").map(s => s.trim().toLowerCase());
        if (!ShadowOmni.memory[p[0]]) ShadowOmni.memory[p[0]] = [];
        ShadowOmni.memory[p[0]].push({ text: p[1], mood: p[2] || 'neutral' });
        ShadowOmni.sync();
        ShadowOmni.bol(config[currentLang].learnMsg, 'happy');
    } else {
        thoughtBox.innerText = "Shadow is processing...";
        let res = ShadowOmni.findFuzzy(val);

        if (res === "correct_mode") {
            ShadowOmni.bol(currentLang === 'en-US' ? "What is the correct data? (key | value)" : "‡§∏‡§π‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à? (key | value)");
        } else if (res) {
            const finalRes = res[res.length-1];
            ShadowOmni.bol(finalRes.text, finalRes.mood);
        } else {
            thoughtBox.innerText = "Brainstorming offline...";
            try {
                const aiReply = await ShadowOmni.askLLM(val);
                if (aiReply) {
                    ShadowOmni.bol(aiReply);
                    ShadowOmni.memory[val.toLowerCase()] = [{ text: aiReply, mood: 'neutral' }];
                    ShadowOmni.sync();
                } else {
                    ShadowOmni.bol(config[currentLang].errorMsg);
                }
            } catch (e) {
                ShadowOmni.bol("Neural Link Error. Please check WebGPU.");
            }
        }
        ShadowOmni.context.push(val);
        if(ShadowOmni.context.length > 5) ShadowOmni.context.shift();
    }
    i.value = "";
}

// Event Listeners
document.getElementById('masterKey').addEventListener('input', () => ShadowOmni.loadMemory());
document.getElementById('sendBtn').addEventListener('click', handleUI);
document.getElementById('userInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') handleUI(); });
document.getElementById('voiceBtn').addEventListener('click', () => {
    const r = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    r.lang = currentLang;
    r.onresult = (e) => { document.getElementById('userInput').value = e.results[0][0].transcript; handleUI(); };
    r.start();
});
document.getElementById('exportBtn').addEventListener('click', () => {
    const d = localStorage.getItem('shadow_brain_enc');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([d], {type: "text/plain"}));
    a.download = "shadow_brain_encrypted.txt";
    a.click();
});
document.getElementById('importTrigger').addEventListener('click', () => document.getElementById('imp').click());
document.getElementById('imp').addEventListener('change', (e) => {
    const r = new FileReader();
    r.onload = (ev) => { localStorage.setItem('shadow_brain_enc', ev.target.result); location.reload(); };
    r.readAsText(e.target.files[0]);
});
document.getElementById('wipeBtn').addEventListener('click', () => { if(confirm("Clear all neural paths?")) { localStorage.clear(); location.reload(); } });

// IndexedDB Logic
let db;
const request = indexedDB.open("ShadowBrainDB", 1);
request.onupgradeneeded = e => {
    db = e.target.result;
    db.createObjectStore("memory", { keyPath: "id" });
};
request.onsuccess = e => { db = e.target.result; };
function saveToIndexedDB(data) {
    if (!db) return;
    const tx = db.transaction("memory", "readwrite");
    tx.objectStore("memory").put({ id: "brain_dump", content: data });
}
</script>
</body>
</html>
